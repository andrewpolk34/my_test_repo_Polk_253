---
title: "For Real, or Fraud? Classification Modeling With Online Job Postings"
author: "Liam Edwards-Gaherty, Matthew Plisko, Andrew Polk, Henry Smith"
date: "4/23/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, echo=FALSE}
#plotting and exploring
library(tidyverse) #for plotting and summarizing
library(GGally) #for nice scatterplot matrix 
library(ggridges) #for joy/ridge plots
library(corrplot) #for basic correlation matrix plot
library(naniar) #for exploring missing values
library(pdp) #for partial dependence plots, MARS models
library(rpart.plot) #for plotting decision trees
library(vip) #for importance plots
library(pROC) #for ROC curves
library(plotROC) #for plotting ROC curves

#making things look nice
library(lubridate) #for nice dates
library(knitr) #for nice tables
library(scales) #for nice labels on graphs
library(gridExtra) #for arranging plots
library(broom) #for nice model output
library(janitor) #for nice names

#data
library(ISLR) #for data
library(moderndive) #for data
library(rattle) #weather data
library(fivethirtyeight) #candy data

#modeling
library(rsample) #for splitting data
library(recipes) #for keeping track of transformations
library(caret) #for modeling
library(leaps) #for variable selection
library(glmnet) #for LASSO
library(earth) #for MARS models
library(rpart) #for decision trees
library(randomForest) #for bagging and random forests

theme_set(theme_minimal())
```

```{r, echo=FALSE}
jobs <- read_csv("fake_job_postings.csv")
```

```{r, echo=FALSE}
jobs <- jobs %>%
add_n_miss(label = "n_miss")
jobs <- jobs %>%
mutate_if(is.character, replace_na, replace = "Missing") %>%
mutate(comp_prof_numchar = nchar(company_profile, type = "char", allowNA = FALSE, keepNA =NA),description_numchar = nchar(description, type = "char", allowNA = FALSE, keepNA =NA)) %>%
mutate(domestic = sapply(strsplit(jobs$location, split = ',', fixed=TRUE), function(x) (x[1]))) %>% 
mutate(domestic = ifelse(domestic == "US",1,0))

jobs <- jobs %>%
  group_by(description,requirements) %>%
  mutate(count = (ifelse(is.na(description)==FALSE & is.na(requirements)==FALSE,n(),1000))) %>% replace_with_na(replace = list(count = 1000))

#divide into training and testing
set.seed(253) #first set the seed!
jobs_split <- initial_split(jobs, prop = .7, 
                             strata = fraudulent)
jobs_train <- training(jobs_split)
jobs_test <- testing(jobs_split)

#distribution of response for the training data
table(jobs_train$fraudulent) %>% prop.table()

#distribution of response for testing data
table(jobs_test$fraudulent) %>% prop.table()

```

# Introduction and Research Questions

For our final project, we used a dataset from Kaggle containing 17,800 online job postings, of which about 5% are fraudulent, fake job postings. Our research questions are:

What are some universal signs of a fraudulent job posting? 

What classification model best identifies the fraudulent job postings in the dataset?

# Data: Modifications and Challenges

Since only 5% of the job postings are fraudulent, we need to develop a highly accurate classification model to identify the fraudulent postings at a statistically significant rate, or significantly above the No Information Rate. The data from Kaggle contains 17,800 observations with 18 variables. The response variable is called **fraudulent**; it is a binary variable, with 0 signifying a legitimate job posting and 1 signifying a fraudulent job posting. We made some modifications and additions to the dataset:
* Replaced empty values with "Missing"
* Generated a variable, **n_miss_all**, to count to amount of missing categories for each job posting
* Generated variables that counted the amount of characters for the **company_profile** and **description** variables
* Generated a binary variable, **domestic**, that designated a job as either domestic (US) or foreign
* Generated a variable, **count**, ... Plisko?

Below is a description of key variables we use in the plots, tables, and models that follow:

[INSERT Henry's Variable Descriptions]

#Exploratory Plots and Tables

1. This plot explores the required_experience variable as it pertains to the fraudulent variable.
```{r, fig.width=9, echo=FALSE}
jobs_train %>%
  ggplot(aes(x = required_experience, fill = as.factor(fraudulent))) +
  geom_bar(position = "fill") +
  ggtitle("Fraudulent Versus Legitimate Job Postings, by Required Experience") +
  labs(x = "Required Experience", y = "Proportion", fill = "Fraudulent")
```

2. This plot explore the has_company_logo variable as it pertain to the fraudulent variable.
```{r, echo=FALSE}
jobs_train %>%
  ggplot(aes(x = as.factor(has_company_logo))) +
  geom_bar(aes(fill = as.factor(fraudulent)), position = "fill") +
  ggtitle("Fraudulent Versus Legitimate Job Postings, by Inclusion of Company Logo") +
  labs(x = "Has Company Logo", fill= "Fraudulent")
```

3. This table shows that a job posting is overwhelmingly likely to be legitimate if it contains the company logo and has questions.
```{r, echo=FALSE}
jobs_train %>%
  filter(has_company_logo == 1, has_questions == 1) %>%
  count(fraudulent)
```


4. This plot filters for job location within the United States, showing that more than half of the job postings within the data are domestic.
```{r, echo=FALSE}
jobs_train %>%
  filter(str_detect(location, 'US,')) %>%
  ggplot(aes(x = as.factor(fraudulent))) +
  geom_bar() +
  ggtitle("Fraudulent Versus Legitimate Job Postings, United States") +
  labs(x = "Fraudulent")
```

5. This plot shows that legitimate job postings have longer company profile descriptions.
```{r, echo=FALSE}
jobs_train %>%
  ggplot(aes(x = as.factor(fraudulent), y = comp_prof_numchar)) +
  geom_boxplot()
```

6. This plot shows that the same can't be said for job description character count; while the highest outliers are legitimate, the average number characters for fraudulent and legitimate job postings is similar.
```{r, echo=FALSE}
jobs_train %>%
  ggplot(aes(x = as.factor(fraudulent), y = description_numchar)) +
  geom_boxplot()
```

# Building Models

**Model1: Log Model With Select Variables**
```{r}
set.seed(253)

jobs_log_model_1 <- train(
    as.factor(fraudulent) ~ telecommuting + has_company_logo + has_questions,
    data = jobs_train,
    method = "glm",
    family = "binomial",
    trControl = trainControl(method = "cv", number = 5),
    metric = "Accuracy",
    na.action = na.omit
)

summary(jobs_log_model_1) %>% 
  coef() %>% 
  tidy() %>% 
  select(`.rownames`, Estimate) %>% 
  mutate(exp_coef = exp(Estimate))
```

CV Accuracy:
```{r, echo=FALSE}
jobs_log_model_1$results$Accuracy
```

Confusion Matrix:
```{r, echo=FALSE}
confusionMatrix(data = predict(jobs_log_model_1, 
                               type = "raw"),
                reference = as.factor(jobs_train$fraudulent),
                positive = "1")
```

ROC:
```{r, echo=FALSE}
#d = actual status, m = predicted probability
jobs_train %>% 
  mutate(PredStatus =  predict(jobs_log_model_1, type = "prob")$`1`) %>%
  ggplot(aes(d = as.numeric(fraudulent), m = PredStatus)) + 
  geom_roc(labelround = 2, size = 1,
           linealpha = .5, pointalpha = .8) +
  geom_abline(slope = 1, intercept = 0, color = "gray")
```

AUC:
```{r, echo=FALSE}
#roc(actual_class, predicted_probability)
jobs_train %>% 
  mutate(PredStatus =  predict(jobs_log_model_1, type = "prob")$`1`) %>%
  roc(fraudulent ~ PredStatus, data=.) %>% 
  auc()
```

**Model 2: Log Model With Other Variables**
```{r}
set.seed(253)

jobs_log_model_2 <- train(
    as.factor(fraudulent) ~ employment_type + required_experience + required_education,
    data = jobs_train,
    method = "glm",
    family = "binomial",
    trControl = trainControl(method = "cv", number = 5),
    metric = "Accuracy",
    na.action = na.omit
)

summary(jobs_log_model_2) %>% 
  coef() %>% 
  tidy() %>% 
  select(`.rownames`, Estimate) %>% 
  mutate(exp_coef = exp(Estimate))
```

CV Accuracy:
```{r, echo=FALSE}
jobs_log_model_2$results$Accuracy
```

Confusion Matrix
```{r, echo=FALSE}
confusionMatrix(data = as.factor(ifelse(predict(jobs_log_model_2$finalModel, 
                               type = "response") > 0.5, "1", "0")) ,
                reference = as.factor(jobs_train$fraudulent),
                positive = "1")

# length(as.factor(ifelse(predict(jobs_log_model_2$finalModel, 
#                               type = "response") > 0.1, "1", "0")))

#length(as.factor(jobs_train$fraudulent))
```

**Model 3: Log Model With All Relevant Variables **
```{r}
set.seed(253)

jobs_log_model_3 <- train(
    as.factor(fraudulent) ~  description_numchar + comp_prof_numchar + domestic + employment_type + has_company_logo + n_miss_all + industry + required_education + required_experience + has_questions,
    data = jobs_train,
    method = "glm",
    family = "binomial",
    trControl = trainControl(method = "cv", number = 5),
    metric = "Accuracy",
    na.action = na.omit
)

summary(jobs_log_model_3) %>% 
  coef() %>% 
  tidy() %>% 
  select(`.rownames`, Estimate) %>% 
  mutate(exp_coef = exp(Estimate))
```

```{r, echo=FALSE}
jobs_log_model_3$results$Accuracy
```

**Model 4: Classification Tree**
```{r}
set.seed(253)

jobs_tree <- train(
  as.factor(fraudulent) ~ description_numchar + comp_prof_numchar + domestic + employment_type + has_company_logo + n_miss_all + industry + required_education + required_experience + has_questions,
  data = jobs_train,
  method = "rpart",
  tuneGrid = data.frame(cp = seq(0, .05, length = 20)),
  trControl = trainControl(method = "cv", number = 5),
  metric = "Accuracy",
  na.action = na.omit
)
```

```{r, echo=FALSE}
jobs_tree$results %>% 
  ggplot(aes(x = cp, y = Accuracy)) +
  geom_point()
```

```{r, echo=FALSE}
jobs_tree$bestTune$cp
```

```{r, echo=FALSE}
jobs_tree$results %>%
  arrange(desc(Accuracy)) %>%
  head(n = 1)
```

```{r, echo=FALSE}
confusionMatrix(data = as.factor(ifelse(predict(jobs_tree$finalModel, 
                               type = "response") > 0.5, "1", "0")) ,
                reference = as.factor(jobs_train$fraudulent),
                positive = "1")
```

**Model 5: Random Forest**
```{r}
set.seed(253)

jobs_randf <- train(
  as.factor(fraudulent) ~ description_numchar + comp_prof_numchar + domestic + employment_type + has_company_logo + n_miss_all + industry + required_education + required_experience + has_questions,
  data = jobs_train, 
  method = "rf",
  trControl = trainControl(method = "oob"),
  tuneGrid = data.frame(mtry = 10),
  ntree = 100, 
  nodesize = 5, 
  metric = "Accuracy",
  na.action = na.omit
)
```

```{r, echo=FALSE}
plot(jobs_randf$finalModel)
```

```{r, echo=FALSE}
jobs_randf$results
```


